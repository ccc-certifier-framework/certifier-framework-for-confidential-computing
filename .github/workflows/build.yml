name: C/C++ CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
    - name: dependencies
      run: |
        sudo apt update -y
        sudo apt install -y libgtest-dev libgflags-dev openssl libssl-dev protobuf-compiler protoc-gen-go golang-go cmake


    - name: test-code-formatting
      run: |
        ./CI/scripts/check-gofmt.sh

    - name: test-core-certifier-programs
      run: |
        echo "******************************************************************"
        echo "* Check that core certifier programs still compile and clear tests"
        echo "******************************************************************"
        echo " "
        pushd src

        #! ---------------------------------------------------------------------
        #! Check that core certifier programs still compile and clear tests
        #! ---------------------------------------------------------------------
        make -f certifier.mak clean
        make -f certifier_tests.mak clean
        make -f certifier.mak
        make -f certifier.mak clean

        make -f certifier_tests.mak clean
        make -f certifier_tests.mak
        ./certifier_tests.exe

        popd

    - name: unit-test-certlib-utility-programs
      run: |
        echo "******************************************************************"
        echo "* Check core Certlib interfaces for utility programs"
        echo "******************************************************************"
        echo " "
        pushd utilities

        # Build utilities
        make -f cert_utility.mak
        make -f policy_utilities.mak

        popd

        pushd ./certifier_service/certlib/test_data

        ../../../utilities/cert_utility.exe                    \
            --operation=generate-policy-key-and-test-keys      \
            --policy_key_output_file=policy_key_file.bin       \
            --policy_cert_output_file=policy_cert_file.bin     \
            --platform_key_output_file=platform_key_file.bin   \
            --attest_key_output_file=attest_key_file.bin

        ./generate_policy.sh

        popd
