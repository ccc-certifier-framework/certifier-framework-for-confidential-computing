name: C/C++ CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
    - name: dependencies
      run: |
        sudo apt update -y
        sudo apt install -y libgtest-dev libgflags-dev openssl libssl-dev protobuf-compiler protoc-gen-go golang-go
    - name: make
      run: |
        #! ---------------------------------------------------------------------
        #! Check that core certifier programs still compile
        cd src
        make -f certifier_tests.mak clean
        make -f certifier.mak
        make -f certifier.mak clean
        make -f certifier_tests.mak
        ./certifier_tests.exe
        #! ---------------------------------------------------------------------
        cd ../sample_apps
        #! Exercise help / usage / list options, for default simple_app
        ./run_example.sh -h
        ./run_example.sh --help
        ./run_example.sh --list
        ./run_example.sh --list simple_app

        #! Re-run help / usage / list options, for simple_app_under_oe
        ./run_example.sh --help simple_app_under_oe
        ./run_example.sh --list simple_app_under_oe

        ./run_example.sh simple_app show_env
        ./run_example.sh simple_app_under_oe show_env

        #! ---------------------------------------------------------------------
        #! Exercise various interfaces in --dry-run mode. This will ensure that
        #! script's execution logic will likely work for different sample apps,
        #! when tested on the appropriate platform and environment.
        #! ---------------------------------------------------------------------
        ./run_example.sh --dry-run simple_app
        ./run_example.sh --dry-run simple_app setup
        ./run_example.sh --dry-run simple_app run_test

        ./run_example.sh --dry-run simple_app_under_oe
        ./run_example.sh --dry-run simple_app_under_oe setup
        ./run_example.sh --dry-run simple_app_under_oe run_test
        ./run_example.sh --dry-run simple_app_under_oe setup_with_auto_policy_generation_for_OE

        #! ---------------------------------------------------------------------
        #! Test: Execute script to compile, build and run simple_app.
        #! This will also check that utilities programs still compile
        ./cleanup.sh
        ./run_example.sh simple_app
        ./cleanup.sh

        #! ---------------------------------------------------------------------
        #! Few other miscellaneous checks
        cd ../certifier_service/oelib
        make clean
        make dummy
